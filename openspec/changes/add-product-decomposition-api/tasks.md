# Implementation Tasks

## 1. Type System Extensions (in @trace.market/types)

- [ ] 1.1 Define `ExternalDataSource` interface
  - Fields: `source` (enum: OpenFoodFacts | OpenLCA | OSHWA | WikiFab), `id` (external ID), `url`, `fetchedAt`, `confidence` (0-1)
- [ ] 1.2 Define `DecompositionMetadata` interface
  - Fields: `externalSources`, `mappingVersion`, `autoGenerated: boolean`
- [ ] 1.3 Extend `ProductInstance` type with optional `externalSources: ExternalDataSource[]`
- [ ] 1.4 Extend `Process` type with optional `externalSource: ExternalDataSource`
- [ ] 1.5 Add Typia validation schemas for new types
- [ ] 1.6 Publish updated `@trace.market/types` package

## 2. API Client Infrastructure

- [ ] 2.1 Create `src/services/apiClients/baseClient.ts`
  - Abstract base class with error handling, retry logic, timeout handling
  - Cache interface (localStorage/IndexedDB abstraction)
- [ ] 2.2 Implement `openFoodFactsClient.ts`
  - `searchProducts(query)`: search by name
  - `getProduct(barcode)`: fetch full product data
  - `getIngredients(barcode)`: parse ingredients array
  - `getProcessingLevel(barcode)`: return NOVA group
- [ ] 2.3 Extend `src/services/openLCAClient.ts`
  - `searchProcesses(keyword)`: find LCI processes
  - `getProcessInputs(processId)`: fetch quantified material/energy inputs
  - `getImpacts(processId)`: fetch environmental impact data
- [ ] 2.4 Implement `oshwaClient.ts`
  - `searchProjects(query)`: search certified hardware
  - `getProject(uid)`: fetch project details
  - `getBOM(uid)`: extract bill of materials from project data
  - Note: OSHWA API endpoint appears to be 404; implement scraper or use certification list HTML
- [ ] 2.5 Implement `wikiFabClient.ts`
  - `searchTutorials(query)`: search WikiFab how-tos
  - `getTutorial(id)`: fetch tutorial with steps
  - `extractMaterials(id)`: parse required materials list
- [ ] 2.6 Implement response caching layer
  - IndexedDB for large responses
  - localStorage for small metadata
  - Cache invalidation strategy (TTL: 7 days default)

## 3. Data Transformation & Mapping

- [ ] 3.1 Create `src/services/transformers/` directory
- [ ] 3.2 Implement `openFoodFactsTransformer.ts`
  - `toFoodInstance(apiData)`: map OFF product → FoodInstance
  - `toInputInstances(ingredients)`: map ingredient list → InputInstance[]
  - `toProcess(novaGroup)`: infer processing steps from NOVA classification
- [ ] 3.3 Implement `openLCATransformer.ts` (extend existing)
  - `toProcess(lciData)`: map LCI process → Process
  - `toInputInstances(flows)`: map input flows → InputInstance[]
  - `toImpacts(impactData)`: map LCIA results → Impact[]
- [ ] 3.4 Implement `oshwaTransformer.ts`
  - `toProductInstance(project)`: map OSHWA project → ProductInstance
  - `toInputInstances(bom)`: map BOM entries → InputInstance[]
  - `detectProcess(project)`: infer assembly/manufacturing process
- [ ] 3.5 Implement `wikiFabTransformer.ts`
  - `toProcess(tutorial)`: map tutorial steps → Process
  - `toInputInstances(materials)`: map materials → InputInstance[]
- [ ] 3.6 Create `decompositionMerger.ts`
  - Merge data from multiple sources
  - Conflict resolution (priority: user input > specific source > generic source)
  - Confidence scoring algorithm

## 4. Decomposition Orchestration

- [ ] 4.1 Create `src/services/productDecomposition.ts`
  - `decomposeProduct(type, identifier)`: main entry point
  - `selectDataSources(type)`: determine which APIs to query based on product type
  - `fetchFromSources(sources, identifier)`: parallel API calls
  - `buildDecompositionTree(responses)`: recursive tree construction
  - `validateDecomposition(tree)`: check for missing required fields
- [ ] 4.2 Implement recursive decomposition logic
  - For each InputInstance, recursively fetch component data
  - Depth limit (default: 3 levels to prevent infinite loops)
  - Circular dependency detection
- [ ] 4.3 Add progress tracking & cancellation
  - EventEmitter for progress updates (e.g., "Fetching ingredients... 50%")
  - Cancellable async operations (AbortController)

## 5. Pinia Store for Decomposition State

- [ ] 5.1 Create `src/stores/decomposition.ts`
  - State: `currentDecomposition`, `isLoading`, `progress`, `errors`
  - Actions: `startDecomposition`, `cancelDecomposition`, `acceptDecomposition`, `rejectDecomposition`
  - Getters: `decompositionTree`, `confidence`, `dataSources`

## 6. UI Components

- [ ] 6.1 Create `src/components/decomposition/ProductDecompositionWizard.vue`
  - Step 1: Select product type/category (dropdown)
  - Step 2: Search external databases (unified search box)
  - Step 3: Review decomposition tree (expandable tree view)
  - Step 4: Edit/override fields (inline editing)
  - Step 5: Accept and merge into editor
- [ ] 6.2 Create `src/components/decomposition/DecompositionTreeView.vue`
  - Recursive tree display with q-tree or custom component
  - Show confidence scores, data sources, edit buttons
  - Expand/collapse nodes
- [ ] 6.3 Create `src/components/decomposition/DataSourceBadge.vue`
  - Display source icon + name (OpenFoodFacts, OpenLCA, etc.)
  - Tooltip with fetch timestamp, confidence, external link
- [ ] 6.4 Update `src/components/editors/FoodInstanceEditor.vue`
  - Add "Import from External Sources" button above type field
  - Open ProductDecompositionWizard on click
- [ ] 6.5 Update `src/components/editors/ProductInstanceEditor.vue`
  - Add similar import button
  - Handle non-food products (hardware, general)
- [ ] 6.6 Create `src/components/decomposition/SourceSelector.vue`
  - Checkbox list to enable/disable specific data sources
  - Priority ordering (drag-and-drop?)

## 7. Testing

- [ ] 7.1 Unit tests for API clients
  - Mock API responses
  - Test error handling (network errors, 404s, malformed JSON)
- [ ] 7.2 Unit tests for transformers
  - Test with real API response samples
  - Edge cases: missing fields, unexpected formats
- [ ] 7.3 Integration tests for decomposition orchestration
  - End-to-end flow with mocked API calls
  - Test recursive logic, depth limits
- [ ] 7.4 UI tests for wizard component
  - Test navigation between steps
  - Test data acceptance/rejection
- [ ] 7.5 Manual testing with live APIs
  - OpenFoodFacts: test with known barcodes
  - OpenLCA: test with sample processes
  - OSHWA: test with certified projects
  - WikiFab: test with popular tutorials

## 8. Documentation

- [ ] 8.1 Update README.md
  - Document new API integration feature
  - Add example usage
- [ ] 8.2 Create API client documentation
  - Document each client's methods, parameters, return types
  - Include rate limit information
- [ ] 8.3 Create transformation logic documentation
  - Document mapping rules for each API
  - Include confidence scoring explanation
- [ ] 8.4 Update openspec/project.md
  - Add new external dependencies
  - Document API keys/credentials (if needed)

## 9. Configuration & Settings

- [ ] 9.1 Add environment variables
  - `VITE_OPENLCA_API_KEY` (if required)
  - `VITE_ENABLE_API_CACHE` (default: true)
  - `VITE_DECOMPOSITION_DEPTH_LIMIT` (default: 3)
- [ ] 9.2 Create user settings UI (optional)
  - Enable/disable specific data sources
  - Set cache TTL
  - Set decomposition depth limit

## 10. Error Handling & Logging

- [ ] 10.1 Implement comprehensive error handling
  - Network errors: retry with exponential backoff
  - API errors (4xx, 5xx): user-friendly error messages
  - Data transformation errors: log and skip invalid data
- [ ] 10.2 Add logging
  - Console logging for development
  - Optional telemetry for production (privacy-aware)
  - Log API call timestamps, success/failure rates

## 11. Performance Optimization

- [ ] 11.1 Implement request deduplication
  - Prevent multiple identical API calls
  - Use shared promises for concurrent requests
- [ ] 11.2 Optimize recursive fetching
  - Parallel fetching where possible
  - Batch requests if APIs support it
- [ ] 11.3 Implement progressive loading
  - Show partial results while fetching deeper levels
  - Lazy-load nested components on tree expansion

## 12. Validation & Acceptance

- [ ] 12.1 Review decomposition results for accuracy
  - Test with 10+ products from each category
  - Compare auto-generated data with manual entry
- [ ] 12.2 User acceptance testing
  - Gather feedback on wizard UI/UX
  - Measure time savings vs. manual entry
- [ ] 12.3 Performance benchmarks
  - Measure average decomposition time
  - Identify bottlenecks (API latency, transformation logic)

## Dependencies

- Task 1 (Type System) must complete before all others
- Task 2 (API Clients) must complete before Task 3 (Transformers)
- Tasks 2-5 must complete before Task 6 (UI Components)
- Task 6 must complete before Task 7 (Testing)

## Estimated Effort

- Type System: 1-2 days
- API Clients: 3-4 days
- Transformers: 3-4 days
- Orchestration: 2-3 days
- Store: 1 day
- UI Components: 4-5 days
- Testing: 3-4 days
- Documentation: 1-2 days
- Total: 18-25 days (3-5 weeks for single developer)
